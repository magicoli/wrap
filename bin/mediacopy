#!/bin/sh

if [ "$1" = "-l" ]
	then
	method=link
	shift
else
	method=copy
fi

source=$1
[ ! -d "$source" ] && echo "usage: $PGM <source path>" && exit 1

[ -f ../sources ] && cd ../sources || { [ -d sources ] && cd sources ] ; }

pwd | xargs basename | grep "^sources$" || exit 2

echo "source: $source"
echo "method: $method"

ls "$source/"*.MPG "$source/"*.MOV "$source/"*.MTS 2>/dev/null | wc -l | sed "s/$/ movies/"

ls "$source/"*.MPG "$source/"*.MOV "$source/"*.MTS 2>/dev/null | sort -n \
	| while read file
do
	i=$(($i + 1))
	if [ ! -f $i.mov ]
		then
		if [ "$method" = "copy" ]
			then
			printf "$file "
			cp -p "$file" $i.mov && echo " > $i.mov"
		else
			ln -s "$file" $i.mov
		fi
	fi
	qt-thumbnailswide.sh -l -1 "$i.mov"
done

exit


removable=/media/usb*

PGM=$(basename "$0")
TMP=/tmp/$PGM.$$

(
    find $removable -iname "*.mp4"
    find $removable -iname "*.mts"
) > $TMP.files

if [ $(basename "$PWD") = "sources" ]
then
    sources=$PWD
else
    if [ -d $PWD/sources ]
	then
	sources=$PWD/sources
    fi
fi

cat $TMP.files | sed "s:[^/]*$::" | sort -u | while read folder
do
    echo "$folder"
    count=$(grep -c "$folder" $TMP.files)
    extension=$(grep "$folder" $TMP.files | sed "s/.*\.//" | sort -u)
    echo "$count $extension videos"
    if [ ! "$sources" ]
	then
	echo "copy these files to a casting sources folder"
	echo "or start this program from a casting folder"
	continue
    fi
    echo "$PGM: copying files"

    rsync --progress -Wavz $folder/*.$extension $sources/

    echo "$PGM: making thumbnails"

    cd $sources
    clips-renumber

    ls *.$extension *.mov 2>/dev/null | sort -n | while read file
    do
	qt-thumbnailswide.sh -1 -l $file
    done

done

rm -f $TMP*
