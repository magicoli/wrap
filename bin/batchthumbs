#!/bin/sh

PGM=`basename "$0"`
TMP="/tmp/$PGM.$$"
method=cannelle

pwd | grep "/hella/" >/dev/null && method=hella

[ ! $1 ] && echo must specify list && exit 1

list=$1

[ "$2" ] && method=$2

echo "method: $method" >&2

cat "$list" | egrep "[A-Za-z]" | while read nr name
do
	[ "$name" = "" ] && continue
	echo "$name" >> "$TMP.list"
	name=`webnormalize "$name"`
	case $method in
		"andrieu")
		thumbname=$lastname
		thumbnr=$(($nr - 1))
		posargs="-e -0"
		lastname=$name
		;;

		"hella")
		thumbname=$lastname
		thumbnr=$(($nr - 2))
		posargs="-e -0"
		lastname=$name
		;;

		"alexandra")
		thumbname=$name
		thumbnr=$(($nr + 1))
		posargs="-1"
		;;
		"cannelle")
		thumbname=$name
		thumbnr=$nr
		posargs="-1"
		# [ -f "../web/.browsercache/$name-thumb.jpg" ] && continue
		# [ -f ".browsercache/$nr-thumb.jpg" ] || continue
		# cp -p ".browsercache/$nr-thumb.jpg" "../web/.browsercache/$name-thumb.jpg"
		;;
		default)
		echo "no method"
		break
		;;
	esac
	thumb="../web/.browsercache/$thumbname-thumb.jpg"
	large="../web/.browsercache/$thumbname-large.jpg"
	[ -f "$thumbnr.mov" ] && source=$thumbnr.mov
	[ -f "$thumbnr.MTS" ] && source=$thumbnr.MTS

	[ ! -f "$thumb" ] \
		&& qt-thumbnailswide.sh $posargs "$source" \
		&& cp -p ".browsercache/$thumbnr-thumb.jpg" "$thumb"
	[ ! -f "$large" ] \
		&& qt-thumbnailswide.sh -l $posargs "$source" \
		&& cp -p ".browsercache/$thumbnr-large.jpg" "$large"

done >&2

makeplaylist "$TMP.list" | sed "s/\$reserve=/\$customnames=/"
