#!/bin/bash

director=$(pwd | sed "s|.*/castings/||" | cut -d / -f 1);
export PATH=$PATH:$(basename "$0")
which helpers >/dev/null && . $(which helpers) || exit 1

for conf in /etc/casting ~/etc/casting /etc/$PGM /usr/local/etc/$PGM ~/etc/$PGM
do
    [ -f $conf ] && . $conf
done

if [ ! "$@" ]
then
  sources=~/castings/$director/upload/server/php/files/
else
  sources=$@
fi
[ -d "$sources/tmp" ] \
&& phptmp=$sources/tmp \
|| phptmp=~/domains/wrap.magiiic.media/tmp

log "watching $sources"

if [ "$remote" ]
then
  log "remote $remote"
  remotehost=$(echo "$remote" | cut -d : -f 1)
  remotepath=$(echo "$remote" | cut -d : -f 2)
  if [ "$1" ]
  then
    client="$1"
  elif [ ! "$client" ]
  then
    client="*"
  fi
fi
log "client $client"

while true
do
  if [ "$remote" -a "$remotehost" ]
  then
    printf "$(date) (connecting $remotehost)\r"
    ssh $remotehost "ls $remotepath/$client/upload/server/php/files/tmp/php* $remotepath/$client/upload/server/php/files/tmp/*.MTS $remotepath/$client/upload/server/php/files/tmp/*.MP4" 2>/dev/null > $TMP.uploads \
    && printf "\r\033[K" \
    && date \
    && notify-send -u critical "Upload in progress on $remotehost for
$(
    cat $TMP.uploads | sed "s:$remotepath/::" | cut -d "/" -f 1 | sort -u | sed "s/^/  /"
    )" \
    && printf "$_\n" \
    && break
    printf "\033[K$(date)"
    read -t 5
    printf "\r\033[K";
    continue
  fi
  clear
  echo $sources
  ls -lrt $sources \
  | egrep '\.MTS|\.MPG|\.MOV|\.MP4|\.MXF' \
  > $TMP.bydate
  lines=$(($(tput lines) - 6))
  [ $lines -gt 0 ] && tail -$lines $TMP.bydate
  sort -k 9 $TMP.bydate \
  > $TMP.files
  printf "$(cat $TMP.files | wc -l) pending files"
  diffs=$(diff $TMP.bydate $TMP.files 2>/dev/null | grep ">" | wc -l)
  [ "$diffs" -eq 0 ] && echo || echo " ($diffs TIME MISMATCHESS" | grep --color ".*"

  ls $sources/tmp/php* >/dev/null 2>/dev/null \
  && phptmp=$sources/tmp \
  || phptmp=~/domains/wrap.magiiic.media/tmp
  echo "$phptmp"
  ls -lrt $phptmp | egrep '[[:blank:]]php'
  date
  read -t 1
done
