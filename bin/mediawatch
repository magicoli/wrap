#!/bin/bash

director=$(pwd | sed "s|.*/castings/||" | cut -d / -f 1); 
export PATH=$PATH:$(basename "$0")
which helpers && . $(which helpers) || exit 1

if [ ! "$@" ]
then
    sources=~/castings/$director/upload/server/php/files/
else
    sources=$@
fi
[ -d "$sources/tmp" ] \
    && phptmp=$sources/tmp \
    || phptmp=~/domains/wrap.magiiic.media/tmp

log "watching $sources"

while true
do
    clear
    echo $sources
    ls -lrt $sources \
        | egrep '\.MTS|\.MPG|\.MOV|\.MP4' \
        | tee $TMP.bydate \
        | tail
    sort -k 9 $TMP.bydate \
        > $TMP.files

    printf "$(cat $TMP.files | wc -l) pending files"
    diffs=$(diff $TMP.bydate $TMP.files 2>/dev/null | grep ">" | wc -l)
    [ "$diffs" -eq 0 ] && echo || echo " ($diffs TIME MISMATCHES)"

    ls $sources/tmp/php* >/dev/null 2>/dev/null \
        && phptmp=$sources/tmp \
        || phptmp=~/domains/wrap.magiiic.media/tmp
    echo "$phptmp"
    ls -lrt $phptmp | egrep '[[:blank:]]php' | tail -1
    date
read -t 1
done
